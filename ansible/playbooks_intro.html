<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Playbooks &mdash; Dhub 0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Dhub 0.1 documentation" href="../index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../index.html">Dhub 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="playbooks">
<span id="playbooks-intro"></span><h1>Playbooks<a class="headerlink" href="#playbooks" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="https://github.com/ansible/ansible-examples">Playbooks</a> examples</p>
<p>每个playbook 至少包含一个 play列表，play的作用就是把一组主机和一组定义好的roles关联起来。</p>
<p>最基本的task就是直接调用ansible的模块:</p>
<div class="highlight-python"><div class="highlight"><pre>---
- hosts: web
  name: install httpd
  gather_facts: true

  tasks:
    - name: install httpd
      yum: name={{ item }} state=installed
      with_items:
        - httpd
        - httpd-devel
      when: ansible_os_family == &quot;Redhat&quot;
      notify:
        - restart apache2

    - name: install httpd
      apt: name={{ item }} state=installed
      with_items:
        - apache2
        - apache2-dev
      when: ansible_os_family == &quot;Debian&quot;
      notify:
        - restart apache2

  handlers:
    - name: restart httpd
      service:
        name=httpd
        state=restarted
      when: ansible_os_family == &quot;Debian&quot;

    - name: restart apache2
      service: name=apache2 state=restarted
      when: ansible_os_family == &quot;Debian&quot;
</pre></div>
</div>
<div class="section" id="hosts-and-users">
<h2>Hosts and Users<a class="headerlink" href="#hosts-and-users" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><div class="highlight"><pre>---
- hosts: webservers
  remote_user: root
</pre></div>
</div>
<p>The <em>hosts</em> line is a list of one or more groups or host patterns,separated by colons.</p>
<p>The <em>remote_user</em> is just the name of the user account.</p>
<p>Remote users can also be defined per task:</p>
<div class="highlight-python"><div class="highlight"><pre>---
- hosts: webserver
  remote_user: root
  tasks:
    - name: test connection
      ping:
      remote_user: localuser
</pre></div>
</div>
<p>Support for running things as another user is also available,you could become a user as root or other different user:</p>
<div class="highlight-python"><div class="highlight"><pre>---
- hosts: webserver
  remote_user: root
  tasks:
    - name: restart httpd
      service: name=httpd state=restarted
      remote_user: localuser
      become: yes
      become_method: sudo

    - name: restart mysql
      service: name=mysqld state=restarted
      remote_user: localuser
      become: yes
      become_user: mysql
      become_method: su
</pre></div>
</div>
</div>
<div class="section" id="tasks-list">
<h2>Tasks list<a class="headerlink" href="#tasks-list" title="Permalink to this headline">¶</a></h2>
<p>Within a play, all hosts are going to get the same task directives. It is the purpose of a play to map a selection of hosts to tasks.</p>
<p>Hosts with failed tasks are taken out of the rotation for the entire playbook. If things fail, simply correct the playbook file and rerun.</p>
<p>The goal of each task is to execute a module with very specific arguments.</p>
<p>Modules are &#8216;idempotent&#8217; (幂等) , meaning if you run them again, they will make only the changes they must in order to bring the system to the desired state. This makes it very safe to rerun the same playbook multiple times.</p>
<p>Every task should have a <em>name</em> , which is included in the output from running the playbook. If the name is not provided though, the string fed to &#8216;action&#8217; will be used for output.</p>
<div class="highlight-python"><div class="highlight"><pre>tasks:
  - name: make sure apache is running
    service: name=httpd state=running
  - name: disable selinux
    command: /sbin/setenforce 0
</pre></div>
</div>
<p><em>command</em> and <em>shell</em> module care about return codes, so if you have a command whose successful exit code is not zero, you may wish to do this:</p>
<div class="highlight-python"><div class="highlight"><pre>tasks:
  - name: run this command and ignore the result
    shell: /usr/bin/somecommand || /bin/true
</pre></div>
</div>
<p>Or this:</p>
<div class="highlight-python"><div class="highlight"><pre>tasks:
  - name: run this command and ignore the result
    shell: /usr/bin/somecommand
    ignore_errors: True
</pre></div>
</div>
<p>Variables can be used in action lines:</p>
<div class="highlight-python"><div class="highlight"><pre>tasks:
  - name: create a virtual host file for {{ vhost }}
    template: src=somefile.j2 dest=/etc/httpd/conf.d/{{ vhost }}
</pre></div>
</div>
</div>
<div class="section" id="handlers-running-operations-on-change">
<h2>Handlers: Running Operations On change<a class="headerlink" href="#handlers-running-operations-on-change" title="Permalink to this headline">¶</a></h2>
<p>Playbooks recognize changes and have a basic event system that can be used to respond to change.</p>
<p>These <em>notify</em> actions are triggered at the end of each block of tasks in a playbook, and will only be triggered once even if notified by multiple different tasks:</p>
<div class="highlight-python"><div class="highlight"><pre>- name: template configuration file
  template: src=template.j2 dest=/etc/foo.conf
  notify:
    - restart memcached
    - restart apache
</pre></div>
</div>
<p>The things listed in the <em>notify</em> section of a task are called handler.</p>
<p>Handlers are lists of tasks, not really any different from regular tasks, that are referenced by name:</p>
<div class="highlight-python"><div class="highlight"><pre>handlers:
  - name: restart memcached
    service: name=memcached state=restarted
  - name: restart apache
    service: name=apache state=restarted
</pre></div>
</div>
<p>Handlers are best used to restart services and trigger reboots.</p>
<p>Handlers are automatically processed between &#8216;pre_tasks&#8217;,&#8217;roles&#8217;,&#8217;tasks&#8217;,&#8217;post_tasks&#8217; sections. if you ever want to flush all handler commands immediately though:</p>
<div class="highlight-python"><div class="highlight"><pre>tasks:
  - shell: some tasks go here
  - meta: flush_handlers
  - shell: some other tasks
</pre></div>
</div>
</div>
<div class="section" id="executing-a-playbook">
<h2>Executing A Playbook<a class="headerlink" href="#executing-a-playbook" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal"><span class="pre">ansible-playbook</span> <span class="pre">playbook.yml</span> <span class="pre">-f</span> <span class="pre">10</span></code></p>
</div>
<div class="section" id="ansible-pull">
<h2>Ansible-Pull<a class="headerlink" href="#ansible-pull" title="Permalink to this headline">¶</a></h2>
<p>ansible-pull is a small script that will checkout a repo of configuration instructions from git, and the run ansible-playbook against that content.</p>
</div>
<div class="section" id="tips-and-tricks">
<h2>Tips and Tricks<a class="headerlink" href="#tips-and-tricks" title="Permalink to this headline">¶</a></h2>
<p>If you ever wanted to see detailed output from successful modules as well as  unsuccessful ones, use <code class="docutils literal"><span class="pre">--verbose</span></code> flag.</p>
<p>To see what hosts would be affected by a playbook before you run it, you can do this:</p>
<div class="highlight-python"><div class="highlight"><pre>ansible-playbook playbook.yml --list-hosts
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Playbooks</a><ul>
<li><a class="reference internal" href="#hosts-and-users">Hosts and Users</a></li>
<li><a class="reference internal" href="#tasks-list">Tasks list</a></li>
<li><a class="reference internal" href="#handlers-running-operations-on-change">Handlers: Running Operations On change</a></li>
<li><a class="reference internal" href="#executing-a-playbook">Executing A Playbook</a></li>
<li><a class="reference internal" href="#ansible-pull">Ansible-Pull</a></li>
<li><a class="reference internal" href="#tips-and-tricks">Tips and Tricks</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/ansible/playbooks_intro.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, Fuyuan.Chu.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.4</a>
      
      |
      <a href="../_sources/ansible/playbooks_intro.txt"
          rel="nofollow">Page source</a></li>
    </div>

    

    
  </body>
</html>